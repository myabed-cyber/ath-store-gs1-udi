<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" id="metaThemeColor" content="#f6f7fb"/>

  <script>
    // Theme boot (prevents flash). localStorage: gs1_ui_theme = "light" | "dark"
    (function () {
      try {
        var key = 'gs1_ui_theme';
        var saved = localStorage.getItem(key);
        var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        var theme = saved || 'light'; // default to LIGHT for predictable UX
        document.documentElement.dataset.theme = theme;
        var meta = document.getElementById('metaThemeColor');
        if (meta) meta.setAttribute('content', theme === 'dark' ? '#050a14' : '#f6f7fb');
      } catch (e) {}
    })();
  </script>

  <link rel="manifest" href="./manifest.webmanifest"/>
  <title>ATH Medical Division â€” Warehouse Hub</title>
  <link rel="icon" href="./assets/logo.svg" type="image/svg+xml"/>

  <!-- Fonts -->

  <!-- Pro UI -->
  <link rel="stylesheet" href="./ui.css">

  <!-- Premium Fonts (optional, with strong fallbacks) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;700;800;900&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
</head>

<body data-page="login" data-auth="0">
  <!-- Ambient Core -->
  <div class="ambient-layer" aria-hidden="true">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
    <div class="grid-overlay"></div>
    <div class="noise-overlay"></div>
  </div>

  <div class="shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sb-top">
        <div class="sb-brand">
        <img class="sb-logo" src="./assets/ath-medical-division.png" alt="ATH Medical Division"/>
        <div class="sb-text">
          <div class="sb-title">ATH Medical Division</div>
          <div class="sb-sub">Warehouse Hub</div>
        </div>
      </div>
      <button class="sb-collapse" id="btnSidebar" title="Collapse / Expand" aria-label="Toggle sidebar"> id="btnSidebar" title="Collapse / Expand" aria-label="Toggle sidebar">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" aria-hidden="true">
            <path d="M4 6h16M4 12h16M4 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <nav class="sb-nav" aria-label="Primary">
        <a class="sb-link" href="#/operator" data-nav="operator" title="Operator">
          <svg class="sb-ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 6h16M4 12h10M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <span data-i18n="nav.operator">Operator</span>
        </a>

        <a class="sb-link" href="#/admin" data-nav="admin" title="Admin">
          <svg class="sb-ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3l8 4v6c0 5-3.5 9-8 8-4.5 1-8-3-8-8V7l8-4z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M9 12l2 2 4-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span data-i18n="nav.admin">Admin</span>
        </a>

        <a class="sb-link" href="#/docs" data-nav="docs" title="Docs">
          <svg class="sb-ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 3h8l4 4v14H7V3z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M15 3v5h5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <span data-i18n="nav.docs">Docs</span>
        </a>
      </nav>

      
<div class="sb-foot">
  <div class="muted mono" id="envHint" style="display:none;"></div>
  <div class="sb-copyright">Â© ATH Medical Division</div>
</div>
</aside>


    <!-- WORKSPACE -->
    <div class="workspace">
      
<header class="topbar glass-panel">
  <div class="tb-left">
    <img class="ath-logo" src="./assets/ath-medical-division.png" alt="ATH Medical Division" />
    <div class="tb-meta">
      <div class="tb-crumb" id="pageCrumb">â€”</div>
      <div class="tb-sub" id="pageSub">â€”</div>
    </div>
  </div>

  <div class="tb-right">
    <div class="toolbar">
      <button class="pill" id="btnTheme" type="button" title="Theme">Dark</button>
      <button class="pill" id="btnLang" type="button" title="Language">EN</button>

      <div class="net-pill" id="netPill" title="API">
        <span class="net-dot" id="netDot"></span>
        <span class="net-text" id="netText">API</span>
      </div>

      <div class="tb-user">
        <div class="user-pill" id="tbUser" title="Account">
          <div class="user-avatar" id="userAvatar">A</div>
          <div class="user-meta">
            <div class="user-name" id="userName">â€”</div>
            <div class="user-role" id="userRole">â€”</div>
          </div>
        </div>
        <button class="pill pill--danger" id="btnLogout" type="button" title="Logout">â‹</button>
      </div>
    </div>
  </div>
</header>


      <main class="main">
        <!-- LOGIN -->
        <section class="page" id="page-login" data-page="login">
  <div class="login-wrapper">
    <div class="login-card glass-panel">
      <div class="login-brand">
        <img class="brand-logo" src="./assets/ath-medical-division.png" alt="ATH Medical Division" />
        <div class="login-brand-text">
          <div class="login-kicker">ATH Medical Division</div>
          <h1 class="login-title" data-i18n="login.title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
          <p class="login-sub" data-i18n="login.credentials">Ø§Ø³ØªØ®Ø¯Ù… Ø­Ø³Ø§Ø¨ Operator Ø£Ùˆ Admin Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.</p>
        </div>
      </div>

      <div class="alert" id="loginAlert" style="display:none"></div>

      <form id="loginForm" class="login-form" autocomplete="on">
        <label class="field">
          <span class="field-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
          <div class="field-control">
            <span class="field-ico">ğŸ‘¤</span>
            <input id="loginUser" name="username" class="form-input" placeholder="operator / admin" autocomplete="username" />
          </div>
        </label>

        <label class="field">
          <span class="field-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</span>
          <div class="field-control">
            <span class="field-ico">ğŸ”’</span>
            <input id="loginPass" name="password" type="password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
          </div>
        </label>

        <button class="btn-primary" id="btnLogin" type="submit">
          <span>Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
          <span class="btn-ico">â†’</span>
        </button>
      </form>

      <div class="session-box glass-panel" id="sessionBox" style="display:none">
        <div class="session-row">
          <div class="session-title">Session</div>
          <div class="session-pill mono" id="sessionLabel">â€”</div>
        </div>
        <div class="session-actions">
          <button class="pill" id="btnResume" type="button">Resume</button>
          <button class="pill pill--danger" id="btnForget" type="button">Forget</button>
        </div>
      </div>

      <div class="login-foot">Â© ATH Medical Division</div>
    </div>
  </div>
</section>

        <!-- OPERATOR -->
        <section class="page" id="page-operator" data-page="operator" hidden>
          <div class="page-head">
            <div>
              <h1 class="h1" data-i18n="operator.title">Operator Console</h1>
              <div class="sub">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ + Ù‚Ø±Ø§Ø± (PASS/WARN/BLOCK) + Ø¥Ù†Ø´Ø§Ø¡ Case Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.</div>
            </div>
            <div class="badge" id="authBadge">â€”</div>
          </div>

          <div class="grid-2">
            <!-- Left: Scanner -->
            <div class="card">
              <div class="row row--between">
                <div>
                  <div class="h2">Scanner</div>
                  <div class="sub">ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø± Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø±Ø§Ø¡Ø© Ø«Ø§Ø¨ØªØ©.</div>
                </div>
                <div class="badge">
                  Pending: <span class="mono" id="qPending">0</span>
                  <button class="btn btn--ghost" id="btnSync" style="margin-inline-start:8px;">Sync</button>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row">
                <label class="field field--inline">
                  <span>Transaction</span>
                  <select id="tplSelect">
                    <option value="RECEIPT">Receipt</option>
                    <option value="TRANSFER">Transfer</option>
                    <option value="RETURN">Return</option>
                    <option value="PICK">Pick</option>
                  </select>
                </label>

                <label class="field field--inline">
                  <span>Engine</span>
                  <select id="engineSelect">
                    <option value="auto">AUTO</option>
                    <option value="bd">BarcodeDetector</option>
                    <option value="zxing">ZXing</option>
                  </select>
                </label>

                <button class="btn btn--primary" id="btnStart">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­</button>
                <button class="btn" id="btnStop" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>
                <button class="btn btn--ghost" id="btnTorch" disabled>ÙÙ„Ø§Ø´</button>
                <button class="btn btn--ghost" id="btnSwap" disabled>ØªØ¨Ø¯ÙŠÙ„</button>
              </div>

              <div style="margin-top:12px;">
                <div class="scanner">
                  <video id="video" playsinline muted></video>
                  <div class="scanner__frame"></div>
                  <div class="scanner__tip">ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±</div>
                </div>
              </div>
            </div>

            <!-- Right: Result + Actions -->
            <div class="card">
              <div class="row row--between">
                <div>
                  <div class="h2">Result</div>
                  <div class="sub">Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ + Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ù† GS1 AI.</div>
                </div>
                <div class="row">
                  <button class="btn btn--ghost" id="btnRescan">Rescan</button>
                  <button class="btn" id="btnCreateCase">Create Case</button>
                  <button class="btn btn--ghost" id="btnCopyJson">Copy JSON</button>
                </div>
              </div>

              <div class="hr"></div>

              <div class="fields" style="grid-template-columns: 1.2fr 1fr;">
                <div class="kv">
                  <div class="kv__k">Decision</div>
                  <div class="kv__v" id="statusPill"><span class="pill">â€”</span></div>
                </div>
                <div class="kv">
                  <div class="kv__k">Last Raw</div>
                  <div class="kv__v mono" id="rawLast">â€”</div>
                </div>
              </div>

              <div style="margin-top:12px;">
                <div class="h2" style="margin-bottom:8px;">Parsed Fields</div>
                <div class="fields" id="fieldsGrid"></div>
              </div>

              
              <details class="fold" id="opCommit">
                <summary>Operations (Commit)</summary>
              <details class="fold" id="opCommit">
                <summary>Operations (Commit)</summary>

<div class="hr"></div>

              <div class="row">
                <button class="btn btn--primary" id="btnCommitReceipt">Commit Receipt</button>
                <button class="btn" id="btnCommitTransfer">Commit Transfer</button>
              </div>

              <div style="margin-top:10px;">
                <pre class="pre" id="commitOut">{ "status": "â€”" }</pre>
              </div>

              
              
              </details>
</details>
              <details class="fold" id="opMap">
                <summary>GTIN Mapping (Advanced)</summary>

<div class="hr"></div>

              <div class="h2">GTIN Mapping</div>
              <div class="sub">Ø±Ø¨Ø· GTIN Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù†ØµØ± (Pilot). ÙŠØ¯Ø¹Ù… Ø§Ù„ØªÙˆØ³Ø¹ Ø¥Ù„Ù‰ Catalog Sync.</div>

              <div class="row" style="margin-top:10px;">
                <input id="gtinInput" class="input" placeholder="GTIN (01)" style="flex: 1 1 180px;" />
                <input id="itemInput" class="input" placeholder="Item name / code" style="flex: 2 1 260px;" />
                <button class="btn" id="btnUpsertMap">Upsert</button>
              </div>
              <div id="mapAlert" class="alert" hidden></div>
            
              </details>
</div>
          </div>
        </section>

        <!-- ADMIN -->
        <section class="page" id="page-admin" data-page="admin" hidden>
          <div class="page-head">
            <div>
              <h1 class="h1" data-i18n="admin.title">Admin Console</h1>
              <div class="sub">Ù„ÙˆØ­Ø© Ù…Ø¤Ø´Ø±Ø§Øª + Inbox Ù„Ù„Ø­Ø§Ù„Ø§Øª + Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† + Ø³Ø¬Ù„ ØªØ¯Ù‚ÙŠÙ‚.</div>
            </div>
            <div class="row">
              <button class="btn btn--primary" id="btnRefreshDash">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ­Ø©</button>
              <button class="btn" id="btnRefreshCases">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª</button>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="h2">KPIs (24h)</div>
              <div class="sub">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¢Ø®Ø± 24 Ø³Ø§Ø¹Ø©.</div>
              <div class="hr"></div>

              <div class="grid-3">
                <div class="kv">
                  <div class="kv__k">Total</div>
                  <div class="kv__v" id="kpiTotal">â€”</div>
                </div>
                <div class="kv">
                  <div class="kv__k">PASS</div>
                  <div class="kv__v" id="kpiPass">â€”</div>
                </div>
                <div class="kv">
                  <div class="kv__k">WARN</div>
                  <div class="kv__v" id="kpiWarn">â€”</div>
                </div>
              </div>

              <div style="margin-top:12px;">
                <div class="kv">
                  <div class="kv__k">BLOCK</div>
                  <div class="kv__v" id="kpiBlock">â€”</div>
                </div>
              </div>
              <details class="fold" id="adAudit">
                <summary>Audit Viewer (Advanced)</summary>


              <div class="hr"></div>

              <div class="h2">Audit Viewer</div>
              <div class="sub">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø« Ø«Ù… Refresh Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù€ payload.</div>

              <div class="row" style="margin-top:10px;">
                <select id="auditType" style="flex: 1 1 220px;">
                  <option value="">ALL</option>
                  <option value="AUTH_LOGIN">AUTH_LOGIN</option>
                  <option value="SCAN_VALIDATED">SCAN_VALIDATED</option>
                  <option value="CASE_CREATED">CASE_CREATED</option>
                  <option value="GTIN_MAP_UPSERT">GTIN_MAP_UPSERT</option>
                  <option value="USER_CREATED">USER_CREATED</option>
                  <option value="USER_UPDATED">USER_UPDATED</option>
                </select>
                <button class="btn btn--ghost" id="btnAudit">Refresh</button>
              </div>

              <div style="margin-top:10px;">
                <pre class="pre" id="auditOut">Ø§Ø®ØªØ± Ø­Ø¯Ø« Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù€ payload.</pre>
              </div>
            
              </details>
</div>

            <div class="card">
              <div class="h2">Cases Inbox</div>
              <div class="sub">ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©/Ø§Ù„Ù‚Ø±Ø§Ø± + Ø¨Ø­Ø« Ù†ØµÙŠ.</div>
              <div class="hr"></div>

              <div class="row">
                <select id="caseStatus" style="flex: 1 1 160px;">
                  <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                  <option value="NEW">NEW</option>
                  <option value="IN_PROGRESS">IN_PROGRESS</option>
                  <option value="RESOLVED">RESOLVED</option>
                </select>

                <select id="caseDecision" style="flex: 1 1 160px;">
                  <option value="">ÙƒÙ„ Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª</option>
                  <option value="WARN">WARN</option>
                  <option value="BLOCK">BLOCK</option>
                </select>

                <input id="caseQ" class="input" placeholder="Ø¨Ø­Ø« (GTIN / Raw)" style="flex: 2 1 220px;" />
              </div>

              <div style="margin-top:12px;" class="table" id="casesTable">
                <div class="table__head">
                  <div>Case</div><div>Raw</div><div>Checks</div><div>Action</div>
                </div>
                <div class="table__body" id="casesBody">
                  <div class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>
                </div>
              </div>
              <details class="fold" id="adUsers">
                <summary>Users & Roles (Advanced)</summary>


              <div class="hr"></div>

              <div class="h2">Users & Roles</div>
              <div class="sub">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Pilot).</div>

              <div class="row" style="margin-top:10px;">
                <input id="newUser" class="input" placeholder="Username" style="flex: 1 1 160px;" />
                <input id="newPass" class="input" placeholder="Password" style="flex: 1 1 160px;" />
                <select id="newRole" style="flex: 1 1 160px;">
                  <option value="operator">operator</option>
                  <option value="admin">admin</option>
                  <option value="auditor">auditor</option>
                </select>
                <button class="btn" id="btnCreateUser">Create</button>
              </div>

              <div style="margin-top:12px;" class="grid-2">
                <div>
                  <div class="muted" style="font-weight:800; margin-bottom:8px;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                  <div class="list" id="usersList"></div>
                </div>
                <div>
                  <div class="muted" style="font-weight:800; margin-bottom:8px;">User Editor</div>
                  <div class="card" style="box-shadow:none;" id="userEditor">
                    <div class="muted">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡.</div>
                  </div>
                </div>
              
              </details>
</div>

            </div>
          </div>
        </section>

        <!-- DOCS -->
        <section class="page" id="page-docs" data-page="docs" hidden>
          <div class="page-head">
            <div>
              <h1 class="h1" data-i18n="docs.title">Docs</h1>
              <div class="sub">Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ§Øª (Runbook / Reference) Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬Ù„Ø¯.</div>
            </div>
          </div>

          <div class="card">
            <div class="sub">
              Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù€ Runbook/Reference/Deck Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ±. Ø¯Ø§Ø®Ù„ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ ØªÙØ­Ù…Ù‘Ù„ Ù…Ù† /downloads.
            </div>
            <div class="hr"></div>

            <div class="grid-2">
              <a class="sb-link" style="border-color: var(--border); background: var(--panel2);" href="./downloads/OWNER_PILOT_RUNBOOK.pdf" target="_blank" rel="noreferrer">
                <span>Owner Pilot Runbook (PDF)</span>
              </a>

              <a class="sb-link" style="border-color: var(--border); background: var(--panel2);" href="./reference.html" target="_blank" rel="noreferrer">
                <span>Reference (HTML)</span>
              </a>
            </div>

            <div class="hr"></div>
            
          </div>
        </section>

        <!-- UNAUTH -->
        <section class="page" id="page-unauth" data-page="unauth" hidden>
          <div class="card card--hero">
            <div class="h1">ØºÙŠØ± Ù…ØµØ±Ø­</div>
            <div class="sub">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©. Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ø­Ø³Ø§Ø¨ ÙŠÙ…Ù„Ùƒ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ØµØ­ÙŠØ­.</div>
            <div class="hr"></div>
            <button class="btn btn--primary" id="btnGoLogin">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          </div>
        </section>
      </main>
    </div>
  </div>


  <!-- Modal -->
  <div class="modal" id="modal" hidden>
    <div class="modal__backdrop" data-close="1"></div>
    <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal__head">
        <div class="modal__title" id="modalTitle">â€”</div>
        <button class="btn btn--ghost" id="modalClose" aria-label="Close">âœ•</button>
      </div>
      <div class="modal__body" id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast" hidden></div>
<!-- App logic -->
  
  <!-- ZXing loader (same-origin, offline-capable) -->
  <script>
  // ZXing on-demand loader with multi-source fallback + localStorage caching.
  // This enables scanning even on file:// (where BarcodeDetector may be unavailable),
  // once the bundle is cached at least once.
  (function(){
    var KEY = '__zxing_umd_cache_v1';
    var loadingPromise = null;

    function injectScript(src){
      return new Promise(function(resolve, reject){
        var s=document.createElement('script');
        s.src=src;
        s.async=true;
        s.onload=function(){ resolve(src); };
        s.onerror=function(){ try{ s.remove(); }catch(e){} reject(new Error('Failed: '+src)); };
        document.head.appendChild(s);
      });
    }

    function injectFromText(jsText){
      return new Promise(function(resolve, reject){
        try{
          var blob=new Blob([jsText], {type:'text/javascript'});
          var url=URL.createObjectURL(blob);
          injectScript(url).then(function(){
            URL.revokeObjectURL(url);
            resolve('blob');
          }).catch(function(err){
            try{ URL.revokeObjectURL(url); }catch(e){}
            reject(err);
          });
        }catch(e){ reject(e); }
      });
    }

    async function fetchText(url){
      var r = await fetch(url, {mode:'cors', cache:'force-cache'});
      if(!r.ok) throw new Error('HTTP '+r.status+' for '+url);
      return await r.text();
    }

    async function trySources(){
      // 1) local vendor (recommended for fully-offline)
      try{ await injectScript('./vendor/zxing-umd.min.js'); return {source:'local'}; }catch(e){}

      // 2) localStorage cache
      try{
        var cached = localStorage.getItem(KEY);
        if(cached && cached.length>1000){
          await injectFromText(cached);
          return {source:'localStorage'};
        }
      }catch(e){}

      // 3) CDN list (download once, then cache)
      var cdns = [
        'https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.1/umd/zxing-browser.min.js',
        'https://unpkg.com/@zxing/browser@0.1.1/umd/zxing-browser.min.js',
        'https://cdn.jsdelivr.net/npm/@zxing/browser@latest/umd/zxing-browser.min.js',
        'https://unpkg.com/@zxing/browser@latest/umd/zxing-browser.min.js'
      ];

      for(var i=0;i<cdns.length;i++){
        var url = cdns[i];
        try{
          var txt = await fetchText(url);
          try{ localStorage.setItem(KEY, txt); }catch(e){}
          await injectFromText(txt);
          return {source:url};
        }catch(e){}
      }

      throw new Error('ZXing bundle unavailable (local, cache, and CDN all failed).');
    }

    window.__ensureZXing = function(){
      if(window.ZXingBrowser || window.ZXing) return Promise.resolve({source:'already-loaded'});
      if(loadingPromise) return loadingPromise;

      loadingPromise = (async function(){
        var info = await trySources();
        if(!(window.ZXingBrowser || window.ZXing)) throw new Error('ZXing loaded but globals missing.');
        window.__zxingSource = info.source;
        return info;
      })().catch(function(err){
        console.error(err);
        window.__zxingSource = 'missing';
        return Promise.reject(err);
      });

      return loadingPromise;
    };
  })();
</script>

<script src="./app.js" defer></script>

  <!-- Theme toggle (button text + meta theme-color update) -->
  <script>
    (function(){
      var key = 'gs1_ui_theme';
      function apply(theme){
        document.documentElement.dataset.theme = theme;
        try { localStorage.setItem(key, theme); } catch(e){}
        var meta = document.getElementById('metaThemeColor');
        if (meta) meta.setAttribute('content', theme === 'dark' ? '#050a14' : '#f6f7fb');
        var btn = document.getElementById('btnTheme');
        if (btn) btn.textContent = (theme === 'dark') ? 'Light' : 'Dark';
      }
      document.addEventListener('DOMContentLoaded', function(){
        var btn = document.getElementById('btnTheme');
        if (!btn) return;
        var current = document.documentElement.dataset.theme || 'light';
        apply(current);
        btn.addEventListener('click', function(){
          var now = document.documentElement.dataset.theme || 'light';
          apply(now === 'dark' ? 'light' : 'dark');
        });
      });
    })();
  </script>
</body>
</html>